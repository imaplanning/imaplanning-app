// Agente Financiero IMA Planning - NÃºcleo Inteligente
class FinancialAdvisorAgent {
  constructor() {
    this.userProfile = {
      nombre: '',
      edad: 0,
      ingresos: 0,
      gastos: 0,
      perfilRiesgo: '',
      objetivos: [],
      hijos: []
    };
    this.currentStep = 'inicio';
    this.conversationHistory = [];
    this.uma = 108.57;
  }

  procesarMensaje(mensajeUsuario) {
    this.conversationHistory.push({
      usuario: mensajeUsuario,
      timestamp: new Date(),
      step: this.currentStep
    });

    const respuesta = this.generarRespuesta(mensajeUsuario);
    
    this.conversationHistory.push({
      agente: respuesta.mensaje,
      timestamp: new Date(),
      step: this.currentStep
    });

    this.currentStep = respuesta.nextStep || this.currentStep;
    return respuesta;
  }

  generarRespuesta(mensajeUsuario) {
    const mensaje = mensajeUsuario.toLowerCase().trim();

    switch (this.currentStep) {
      case 'inicio':
        return this.procesarInicio(mensaje);
      case 'diagnostico':
        return this.procesarDiagnostico(mensaje);
      case 'fondo_emergencia':
        return this.procesarFondoEmergencia(mensaje);
      case 'seguros':
        return this.procesarSeguros(mensaje);
      case 'retiro':
        return this.procesarRetiro(mensaje);
      case 'proyectos':
        return this.procesarProyectos(mensaje);
      case 'recomendacion':
        return this.procesarRecomendacion(mensaje);
      default:
        return this.procesarDefault(mensaje);
    }
  }

  procesarInicio(mensaje) {
    return {
      mensaje: "Â¡Hola! Soy tu asesor financiero IMA. Â¿EstÃ¡s listo para comenzar un proceso que transformarÃ¡ tu relaciÃ³n con el dinero?",
      opciones: [
        { texto: "âœ… SÃ­, empecemos", next: "diagnostico" },
        { texto: "ğŸ¤” CuÃ©ntame mÃ¡s", next: "explicacion_ima" }
      ],
      nextStep: "diagnostico"
    };
  }

  procesarDiagnostico(mensaje) {
    if (!this.userProfile.nombre) {
      this.userProfile.nombre = mensaje;
      return {
        mensaje: `Mucho gusto ${mensaje}! Â¿CuÃ¡l es tu edad?`,
        nextStep: "diagnostico"
      };
    }

    if (!this.userProfile.edad && !isNaN(mensaje)) {
      this.userProfile.edad = parseInt(mensaje);
      return {
        mensaje: "Perfecto. Â¿CuÃ¡les son tus ingresos mensuales netos?",
        nextStep: "diagnostico"
      };
    }

    if (!this.userProfile.ingresos && !isNaN(mensaje)) {
      this.userProfile.ingresos = parseFloat(mensaje);
      return {
        mensaje: "Gracias. Â¿Tienes hijos menores de 12 aÃ±os? (responde sÃ­ o no)",
        nextStep: "diagnostico"
      };
    }

    if (mensaje.includes('si') || mensaje.includes('sÃ­')) {
      this.userProfile.hijos = [{ edad: 12 }];
      return {
        mensaje: "Entendido. Ahora tengo informaciÃ³n suficiente. Te presento los 4 pilares IMA:\n\nğŸ›¡ï¸ 1. Fondo de emergencias\nğŸ¥ 2. Seguros de vida y gastos mÃ©dicos\nğŸŒ´ 3. PlanificaciÃ³n de retiro\nğŸ“š 4. Proyectos de educaciÃ³n\n\nÂ¿Por cuÃ¡l te gustarÃ­a comenzar?",
        opciones: [
          { texto: "ğŸ›¡ï¸ Fondo de emergencias", next: "fondo_emergencia" },
          { texto: "ğŸ¥ Seguros mÃ©dicos y vida", next: "seguros" },
          { texto: "ğŸŒ´ Mi retiro", next: "retiro" },
          { texto: "ğŸ“š EducaciÃ³n hijos", next: "proyectos" }
        ],
        nextStep: "fondo_emergencia"
      };
    } else {
      return {
        mensaje: "Perfecto. Ahora tengo informaciÃ³n suficiente. Te presento los 4 pilares IMA:\n\nğŸ›¡ï¸ 1. Fondo de emergencias\nğŸ¥ 2. Seguros de vida y gastos mÃ©dicos\nğŸŒ´ 3. PlanificaciÃ³n de retiro\nğŸ“š 4. Proyectos personales\n\nÂ¿Por cuÃ¡l te gustarÃ­a comenzar?",
        opciones: [
          { texto: "ğŸ›¡ï¸ Fondo de emergencias", next: "fondo_emergencia" },
          { texto: "ğŸ¥ Seguros mÃ©dicos y vida", next: "seguros" },
          { texto: "ğŸŒ´ Mi retiro", next: "retiro" },
          { texto: "ğŸ¯ Proyectos personales", next: "proyectos" }
        ],
        nextStep: "fondo_emergencia"
      };
    }
  }

  procesarFondoEmergencia(mensaje) {
    const gastosMensuales = this.userProfile.gastos || this.userProfile.ingresos * 0.7;
    const fondo3Meses = gastosMensuales * 3;
    const fondo6Meses = gastosMensuales * 6;
    const fondo12Meses = gastosMensuales * 12;

    return {
      mensaje: `ğŸ›¡ï¸ **FONDO DE EMERGENCIAS**\n\nBasado en tus ingresos, tu fondo de emergencia deberÃ­a ser:\n\nâ€¢ **MÃ­nimo (3 meses):** $${fondo3Meses.toLocaleString()}\nâ€¢ **Recomendado (6 meses):** $${fondo6Meses.toLocaleString()}\nâ€¢ **Ã“ptimo (12 meses):** $${fondo12Meses.toLocaleString()}\n\nÂ¿Te gustarÃ­a conocer estrategias para construir este fondo?`,
      opciones: [
        { texto: "ğŸ’¡ Ver estrategias de ahorro", next: "seguros" },
        { texto: "ğŸ”„ Siguiente pilar (Seguros)", next: "seguros" }
      ],
      nextStep: "seguros"
    };
  }

  procesarSeguros(mensaje) {
    const ingresoAnual = this.userProfile.ingresos * 12;
    const primaMinima = ingresoAnual * 0.08;
    const primaMaxima = ingresoAnual * 0.15;
    const primaRecomendada = ingresoAnual * 0.12;
    
    const sumaAseguradaVida = ingresoAnual * 10;

    return {
      mensaje: `ğŸ¥ **SEGUROS DE GASTOS MÃ‰DICOS Y VIDA**\n\n**Gastos MÃ©dicos Mayores:**\nâ€¢ Prima recomendada: $${primaRecomendada.toLocaleString()} anual (8-15% de tu ingreso)\nâ€¢ Rango: $${primaMinima.toLocaleString()} - $${primaMaxima.toLocaleString()}\nâ€¢ **DEDUCIBLE DE IMPUESTOS**\n\n**Seguro de Vida + ITP:**\nâ€¢ Suma asegurada: $${sumaAseguradaVida.toLocaleString()} (10 aÃ±os de ingresos)\nâ€¢ Cobertura ITP: **IGUAL** a fallecimiento\nâ€¢ ProtecciÃ³n integral para tu familia`,
      opciones: [
        { texto: "ğŸŒ´ Siguiente pilar (Retiro)", next: "retiro" },
        { texto: "ğŸ“Š Ver plan completo", next: "recomendacion" }
      ],
      nextStep: "retiro"
    };
  }

  procesarRetiro(mensaje) {
    const ingresoAnual = this.userProfile.ingresos * 12;
    const ingresoRequeridoRetiro = ingresoAnual * 0.8;
    const capitalNecesario = ingresoRequeridoRetiro / 0.04;
    
    const umaAnual = this.uma * 365;
    const limiteDeduccion = 5 * umaAnual;
    const limiteRetiroExento = 90 * umaAnual;

    return {
      mensaje: `ğŸŒ´ **PLANIFICACIÃ“N DE RETIRO**\n\nâ€¢ Tasa reemplazo objetivo: **80%** ($${ingresoRequeridoRetiro.toLocaleString()}/aÃ±o)\nâ€¢ Capital necesario: $${capitalNecesario.toLocaleString()}\n\n**LÃ­mites fiscales 2024:**\nâ€¢ DeducciÃ³n PPR: $${limiteDeduccion.toLocaleString()} (5 UMAs)\nâ€¢ Retiro exento: $${limiteRetiroExento.toLocaleString()} (90 UMAs)`,
      opciones: [
        { texto: "ğŸ“š Siguiente pilar", next: "proyectos" },
        { texto: "ğŸ¯ Ver recomendaciÃ³n final", next: "recomendacion" }
      ],
      nextStep: "proyectos"
    };
  }

  procesarProyectos(mensaje) {
    if (this.userProfile.hijos.length > 0) {
      const costoUniversidad = 500000;
      const anosHastaUniversidad = 6;
      const ahorroMensual = this.calcularAhorroMensual(costoUniversidad, anosHastaUniversidad);

      return {
        mensaje: `ğŸ“š **PLAN DE EDUCACIÃ“N**\n\nPara la educaciÃ³n universitaria de tus hijos:\n\nâ€¢ Costo estimado: $${costoUniversidad.toLocaleString()}\nâ€¢ Ahorro mensual: $${ahorroMensual.toLocaleString()}\nâ€¢ Horizonte: ${anosHastaUniversidad} aÃ±os\n\nğŸ’¡ **RecomendaciÃ³n:** Iniciar ASAP para aprovechar interÃ©s compuesto`,
        opciones: [
          { texto: "ğŸ“Š Ver plan integral", next: "recomendacion" },
          { texto: "ğŸ‘¨â€ğŸ’¼ AsesorÃ­a personalizada", next: "asesoria_personal" }
        ],
        nextStep: "recomendacion"
      };
    } else {
      return {
        mensaje: `ğŸ¯ **PROYECTOS PERSONALES**\n\nÂ¿Tienes proyectos especÃ­ficos en mente?\n\nâ€¢ Compra de vivienda\nâ€¢ Negocio propio\nâ€¢ Viajes importantes\nâ€¢ Otros proyectos\n\nCuÃ©ntame sobre tus metas y te ayudo a planificarlas.`,
        opciones: [
          { texto: "ğŸ“Š Ver plan integral", next: "recomendacion" },
          { texto: "ğŸ’¼ Comenzar implementaciÃ³n", next: "asesoria_personal" }
        ],
        nextStep: "recomendacion"
      };
    }
  }

  procesarRecomendacion(mensaje) {
    return {
      mensaje: `ğŸ¯ **PLAN FINANCIERO COMPLETO IMA PLANNING**\n\nHola ${this.userProfile.nombre}, basado en tu perfil:\n\nğŸ“Š **Resumen de Recomendaciones:**\n\nğŸ›¡ï¸ **Fondo de Emergencias:** 6 meses de gastos\nğŸ¥ **Seguros:** 10-12% de tu ingreso anual\nğŸŒ´ **Retiro:** Tasa de reemplazo del 80%\nğŸ“š **EducaciÃ³n/Proyectos:** Ahorro sistemÃ¡tico\n\nğŸ’¡ **Siguientes Pasos:**\n1. Establecer fondo de emergencia prioritario\n2. Cotizar seguros con cobertura ITP\n3. Iniciar aportaciones a PPR\n4. Planificar proyectos especÃ­ficos\n\nÂ¿Te gustarÃ­a profundizar en algÃºn aspecto?`,
      opciones: [
        { texto: "ğŸ›¡ï¸ Profundizar en Emergencias", next: "fondo_emergencia" },
        { texto: "ğŸ¥ Profundizar en Seguros", next: "seguros" },
        { texto: "ğŸŒ´ Profundizar en Retiro", next: "retiro" },
        { texto: "ğŸ”„ Nueva conversaciÃ³n", next: "inicio" }
      ],
      nextStep: "recomendacion"
    };
  }

  procesarDefault(mensaje) {
    return {
      mensaje: "Entiendo. Â¿Te gustarÃ­a revisar algÃºn pilar en especÃ­fico o prefieres ver la recomendaciÃ³n integral?",
      opciones: [
        { texto: "ğŸ›¡ï¸ Fondo emergencias", next: "fondo_emergencia" },
        { texto: "ğŸ¥ Seguros", next: "seguros" },
        { texto: "ğŸŒ´ Retiro", next: "retiro" },
        { texto: "ğŸ“š EducaciÃ³n/Proyectos", next: "proyectos" },
        { texto: "ğŸ“Š RecomendaciÃ³n completa", next: "recomendacion" }
      ],
      nextStep: "recomendacion"
    };
  }

  calcularAhorroMensual(meta, anos) {
    const tasa = 0.07;
    const meses = anos * 12;
    const tasaMensual = tasa / 12;
    const factor = (Math.pow(1 + tasaMensual, meses) - 1) / tasaMensual;
    return Math.round(meta / factor);
  }

  getProgreso() {
    const steps = ['inicio', 'diagnostico', 'fondo_emergencia', 'seguros', 'retiro', 'proyectos', 'recomendacion'];
    const currentIndex = steps.indexOf(this.currentStep);
    return Math.round((currentIndex / steps.length) * 100);
  }
}

export default FinancialAdvisorAgent;